---
title: Aegis Shield
description: Outbound secret protection
---

# Aegis Shield

Aegis Shield is the outbound protection layer. It catches secrets before they leave your machine.

## What it does

1. **Detects** secrets in your code using patterns and context
2. **Tokenizes** them with deterministic, reversible tokens
3. **Preserves** code structure so AI can still understand it
4. **Rehydrates** tokens back to real values in AI responses

## Token categories

| Category | What it matches | Example |
|----------|-----------------|---------|
| `KEY` | API keys, access keys | `AKIAIOSFODNN7EXAMPLE`, `sk_live_...` |
| `SECRET` | Passwords, secrets | `supersecret123` |
| `CONN` | Connection strings | `postgres://user:pass@host/db` |
| `HOST` | Hostnames, URLs | `prod.internal.company.com` |
| `USER` | Usernames in auth contexts | `admin`, `root` |
| `TOKEN` | JWTs, bearer tokens | `eyJhbGciOiJ...` |

## CLI usage

**Find secrets:**

```bash
takumo-aegis scan ./src/
```

```
Found 5 secrets across 3 files:

src/config.ts
  Line 8    AWS Access Key       AKIAIOSFODNN7...
  Line 12   Database URL         postgres://admin:...

src/lib/stripe.ts
  Line 3    Stripe Secret Key    sk_live_51ABC...

src/.env
  Line 1    JWT Secret           eyJhbGciOiJIUz...
  Line 2    API Key              api_key_prod_...
```

**Preview tokenized output:**

```bash
takumo-aegis tokenize ./src/config.ts
```

```typescript
// Original had: postgres://admin:secret@prod:5432/app
export const dbUrl = "__TAKUMO_v1_CONN_a1b2c3d4__";

// Original had: AKIAIOSFODNN7EXAMPLE
export const awsKey = "__TAKUMO_v1_KEY_e5f6g7h8__";
```

**Full round-trip with Claude:**

```bash
takumo-aegis shield ./src/config.ts --prompt "Add connection retry logic"
```

## API usage

```typescript
import { createSession } from '@takumo/aegis';

// Create a session (holds the token vault)
const session = createSession();

// Tokenize your code
const { content, detections } = session.tokenize(sourceCode, 'config.ts');

console.log(`Found ${detections.length} secrets`);
console.log(content);  // Safe to send to AI

// ... send `content` to Claude, get response ...

// Restore secrets in the response
const { content: finalCode, rehydratedCount } = session.rehydrate(claudeResponse);

console.log(`Restored ${rehydratedCount} secrets`);
console.log(finalCode);  // Has real secrets again
```

## Multi-file sessions

One session can handle multiple files. Same secret = same token across files:

```typescript
const session = createSession();

// Both files use the same database password
const config = session.tokenize(configCode, 'config.ts');
const migrate = session.tokenize(migrateCode, 'migrate.ts');

// The password token is identical in both outputs
// Claude can see they use the same credential
```

## Performance

| Operation | 100 lines | 1,000 lines | 10,000 lines |
|-----------|-----------|-------------|--------------|
| Scan | ~5ms | ~50ms | ~200ms |
| Tokenize | ~2ms | ~10ms | ~50ms |
| Rehydrate | ~1ms | ~5ms | ~20ms |
